%% 模型训练全流程（数据准备→训练→评估→部署）
flowchart TD
    A[开始] --> B[数据准备]
    
    subgraph 数据预处理
        B --> C[加载历史数据<br/>(特征+标签)]
        C --> D[数据清洗<br/>(去重/补缺失值)]
        D --> E[类别平衡<br/>(过采样/欠采样)]
        E --> F[特征标准化<br/>(Z-score/Min-Max)]
        F --> G[划分数据集<br/>(训练集80%/测试集20%)]
    end
    
    G --> H[模型选择<br/>(基于协议类型和历史性能)]
    
    subgraph 模型训练
        H --> I{训练类型}
        I -->|单次训练| J[初始化指定模型<br/>(XGBoost/随机森林/LSTM等)]
        I -->|AutoML训练| K[自动协议检测<br/>(分析数据中的协议类型)]
        K --> L[为每种协议选择最优模型<br/>(基于历史性能和协议特征)]
        L --> M[训练各协议专用模型]
        M --> N[训练通用模型<br/>(适用于所有协议)]
        
        I -->|持续训练| O[增量更新现有模型<br/>(仅使用新数据)]
        
        J --> P[训练模型<br/>(早停策略防过拟合)]
        N --> P
        O --> P
    end
    
    subgraph 模型评估
        P --> Q[在测试集上评估]
        Q --> R[计算核心指标<br/>(F1/精确率/召回率/AUC)]
        R --> S[生成评估报告<br/>(混淆矩阵/ROC曲线)]
    end
    
    subgraph 模型部署
        S --> T{性能达标?}
        T -->|是| U[保存模型版本<br/>(含时间戳+指标)]
        T -->|否| V[调整参数<br/>& 重新训练]
        V --> J
        
        U --> W[更新模型符号链接<br/>(latest → 新模型)]
        W --> X[通知检测模块<br/>加载新模型]
        X --> Y[更新模型选择器性能记录]
    end
    
    Y --> Z[结束]