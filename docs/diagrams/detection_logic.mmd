%% 异常检测决策逻辑（模型+规则混合判定）
graph TD
    A[输入特征向量] --> B{检测模式}
    
    B -->|纯模型模式| C[加载最优模型]
    C --> D[预测异常概率P]
    D --> E{概率P > 阈值?}
    E -->|是| F[判定为异常]
    E -->|否| G[判定为正常]
    
    B -->|纯规则模式| H[加载协议专属规则]
    H --> I[检查规则匹配<br/>(包大小/速率/标志位等)]
    I --> J{满足任一异常规则?}
    J -->|是| F
    J -->|否| G
    
    B -->|混合模式| K[并行执行模型+规则检测]
    K --> L[模型结果: 概率P]
    K --> M[规则结果: 匹配状态S]
    L & M --> N{逻辑判定<br/>(P>阈值 OR S=异常)}
    N -->|是| F
    N -->|否| G
    
    F --> O[记录异常详情<br/>(特征+概率+规则)]
    O --> P[触发告警<br/>(按严重程度分级)]
    
    G --> Q[记录正常流量<br/>(仅关键指标)]
    
    P --> R[输出结果]
    Q --> R